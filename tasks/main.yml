---
- name: "Install and remove packages"
  block:
    - name: "Install packages"
      when: prepare_host__packages_installed | default(false)
      changed_when: false == true
      ansible.builtin.package:
        name: "{{ prepare_host__packages_installed }}"

    - name: "Remove packages and config files"
      when: prepare_host__packages_removed | default(false)
      changed_when: false == true
      ignore_errors: true
      ansible.builtin.package:
        state: absent
        name: "{{ prepare_host__packages_removed }}"

- name: "Create Groups with GID"
  when: prepare_host__users | default(false)
  loop: "{{ prepare_host__users }}"
  loop_control:
    loop_var: user
  ansible.builtin.group:
    name: "{{ user.group }}"
    state: present
    gid: "{{ user.gid | default(false)}}"

- name: "Create Users"
  when: prepare_host__users | default(false)
  loop: "{{ prepare_host__users }}"
  loop_control:
    loop_var: user
  ansible.builtin.user:
    name: "{{ user.login }}"
    group: "{{ user.group }}"
    password: "{{ user.password | password_hash('sha512') }}"
    update_password: on_create
    state: present
    append: true
    uid: "{{ user.uid | default(false)}}"

- name: "Import sudoers"
  when: prepare_host__users | default(false)
  ansible.builtin.template:
    src: "templates/sudoers.j2"
    dest: "/etc/sudoers"
    group: "root"
    owner: "root"
    mode: 0440

- name: "Handle system users"
  when: prepare_host__system_users | default(false)
  block:
    - name: "Create Groups"
      loop: "{{ prepare_host__system_users }}"
      loop_control:
        loop_var: user
      ansible.builtin.group:
        name: "{{ user.group }}"
        state: present
        gid: "{{ user.gid | default(false)}}"

    - name: "Add system user"
      loop: "{{ prepare_host__system_users }}"
      loop_control:
        loop_var: user
      ansible.builtin.user:
        name: "{{ user.login }}"
        group: "{{ user.group }}"
        state: present
        system: true
        create_home: false
        append: true
        shell: "/sbin/nologin"
        uid: "{{ user.uid | default(false)}}"

- name: "Handle iptables rules"
  block:
    - name: "Install package: iptables-persistent"
      changed_when: false == true
      ansible.builtin.package:
        name: "iptables-persistent"

    - name: "Add a cron file under /etc/cron.d: save"
      ansible.builtin.cron:
        cron_file: "ansible_iptables_persistent"
        name: "Iptables SAVE"
        weekday: "*"
        minute: "*/5"
        hour: "*"
        user: "root"
        job: "$(/usr/sbin/iptables-save > /etc/iptables/rules.v4) > /dev/null 2>&1"
        state: present

    - name: "Add a cron file under /etc/cron.d: restore"
      ansible.builtin.cron:
        cron_file: "ansible_iptables_persistent"
        name: "Iptables RESTORE"
        special_time: "reboot"
        user: "root"
        job: "$(/usr/sbin/iptables-restore < /etc/iptables/rules.v4) > /dev/null 2>&1"
        state: present
