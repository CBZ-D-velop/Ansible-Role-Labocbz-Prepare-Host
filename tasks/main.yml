---
- name: "Update the host"
  block:
    - name: "Update / clean and dist-upgrade the host"
      ansible.builtin.package:
        update_cache: yes
        autoclean: yes
        autoremove: yes

    - name: "Check if reboot is required or not"
      register: reboot_required_file
      ansible.builtin.stat:
        path: /var/run/reboot_required

    - name: "Reboot the host if required"
      when: reboot_required_file.stat.exists
      ansible.builtin.reboot:
        msg: "(ANSIBLE): The host have to be rebooted."
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime

- name: "Install and remove packages"
  block:
    - name: "Install packages"
      when: prepare_host_packages_installed | default(false)
      register: output
      changed_when: output.changed != true
      ansible.builtin.package:
        name: "{{ prepare_host_packages_installed }}"

    - name: "Remove packages and config files"
      when: prepare_host_packages_removed | default(false)
      register: output
      changed_when: output.changed != true
      ansible.builtin.package:
        state: absent
        name: "{{ prepare_host_packages_removed }}"

- name: "Create Groups"
  when: prepare_host_users | default(false)
  loop: "{{ prepare_host_users }}"
  loop_control:
    loop_var: user
  ansible.builtin.group:
    name: "{{ user.group }}"
    state: present

- name: "Create Users"
  when: prepare_host_users | default(false)
  loop: "{{ prepare_host_users }}"
  loop_control:
    loop_var: user
  ansible.builtin.user:
    name: "{{ user.login }}"
    group: "{{ user.group }}"
    state: present

- name: "Import sudoers"
  when: prepare_host_users | default(false)
  ansible.builtin.template:
    src: "templates/sudoers.j2"
    dest: "/etc/sudoers"
    group: "root"
    owner: "root"
    mode: 0440
